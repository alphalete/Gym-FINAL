<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Data Check</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .loading { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 20px; margin: 10px 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; white-space: pre-wrap; }
        .client-card { border: 1px solid #ccc; margin: 10px 0; padding: 10px; border-radius: 5px; }
        .test-client { background-color: #e8f5e8; border-color: #28a745; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Alphalete Club Debug Page</h1>
        <p>This page will help diagnose data issues by fetching directly from the API.</p>
        
        <button onclick="clearAllCaches()">üóëÔ∏è Clear ALL Caches</button>
        <button onclick="testAPIConnection()">üîó Test API Connection</button>
        <button onclick="fetchAllData()">üìä Fetch All Data</button>
        
        <div id="status" class="section loading">
            <h3>Status</h3>
            <div id="statusContent">Ready to test...</div>
        </div>
        
        <div id="apiResults" class="section">
            <h3>API Connection Test</h3>
            <div id="apiContent">Click "Test API Connection" to check connectivity</div>
        </div>
        
        <div id="clientsData" class="section">
            <h3>Clients Data</h3>
            <div id="clientsContent">Click "Fetch All Data" to load clients</div>
        </div>
        
        <div id="paymentsData" class="section">
            <h3>Payments Data</h3>
            <div id="paymentsContent">Click "Fetch All Data" to load payments</div>
        </div>
        
        <div id="testClients" class="section">
            <h3>Test Clients Found</h3>
            <div id="testClientsContent">Will show after fetching data</div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        
        function log(message) {
            console.log(message);
            const statusContent = document.getElementById('statusContent');
            statusContent.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
        }
        
        async function clearAllCaches() {
            log('üóëÔ∏è Starting complete cache clear...');
            
            try {
                // Clear localStorage
                localStorage.clear();
                log('‚úÖ localStorage cleared');
                
                // Clear sessionStorage
                sessionStorage.clear();
                log('‚úÖ sessionStorage cleared');
                
                // Clear all caches
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    for (const cacheName of cacheNames) {
                        await caches.delete(cacheName);
                        log(`‚úÖ Cache deleted: ${cacheName}`);
                    }
                }
                
                // Unregister service worker
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (const registration of registrations) {
                        await registration.unregister();
                        log('‚úÖ Service worker unregistered');
                    }
                }
                
                // Clear IndexedDB
                if ('indexedDB' in window) {
                    try {
                        const deleteDB = indexedDB.deleteDatabase('AlphaleteDB');
                        deleteDB.onsuccess = () => log('‚úÖ IndexedDB cleared');
                        deleteDB.onerror = () => log('‚ö†Ô∏è IndexedDB clear failed');
                    } catch (e) {
                        log('‚ö†Ô∏è IndexedDB clear error: ' + e.message);
                    }
                }
                
                document.getElementById('status').className = 'section success';
                log('üéâ ALL CACHES CLEARED! Please refresh the main app now.');
                
            } catch (error) {
                log('‚ùå Cache clear error: ' + error.message);
                document.getElementById('status').className = 'section error';
            }
        }
        
        async function testAPIConnection() {
            log('üîó Testing API connection...');
            
            try {
                // Test health endpoint
                const healthResponse = await fetch(`${API_BASE}/api/health`);
                if (healthResponse.ok) {
                    const healthData = await healthResponse.json();
                    log('‚úÖ Health check passed: ' + healthData.message);
                    document.getElementById('apiContent').innerHTML = `
                        <div class="success">
                            <strong>‚úÖ API Connection: SUCCESS</strong><br>
                            Health Status: ${healthData.status}<br>
                            Message: ${healthData.message}<br>
                            Timestamp: ${healthData.timestamp}
                        </div>
                    `;
                } else {
                    throw new Error(`Health check failed: ${healthResponse.status}`);
                }
                
                // Test clients endpoint
                const clientsResponse = await fetch(`${API_BASE}/api/clients`);
                if (clientsResponse.ok) {
                    const clientsData = await clientsResponse.json();
                    log(`‚úÖ Clients API: ${clientsData.length} clients found`);
                    document.getElementById('apiContent').innerHTML += `
                        <div class="success">
                            <strong>‚úÖ Clients API: SUCCESS</strong><br>
                            Total Clients: ${clientsData.length}
                        </div>
                    `;
                } else {
                    throw new Error(`Clients API failed: ${clientsResponse.status}`);
                }
                
                // Test payments stats endpoint
                const paymentsResponse = await fetch(`${API_BASE}/api/payments/stats`);
                if (paymentsResponse.ok) {
                    const paymentsData = await paymentsResponse.json();
                    log(`‚úÖ Payments API: TTD ${paymentsData.total_revenue} total revenue`);
                    document.getElementById('apiContent').innerHTML += `
                        <div class="success">
                            <strong>‚úÖ Payments API: SUCCESS</strong><br>
                            Total Revenue: TTD ${paymentsData.total_revenue}<br>
                            Payment Count: ${paymentsData.payment_count}
                        </div>
                    `;
                } else {
                    throw new Error(`Payments API failed: ${paymentsResponse.status}`);
                }
                
            } catch (error) {
                log('‚ùå API test failed: ' + error.message);
                document.getElementById('apiContent').innerHTML = `
                    <div class="error">
                        <strong>‚ùå API Connection: FAILED</strong><br>
                        Error: ${error.message}
                    </div>
                `;
            }
        }
        
        async function fetchAllData() {
            log('üìä Fetching all data...');
            
            try {
                // Fetch clients
                const clientsResponse = await fetch(`${API_BASE}/api/clients`);
                const clients = await clientsResponse.json();
                
                document.getElementById('clientsContent').innerHTML = `
                    <strong>Total Clients: ${clients.length}</strong><br>
                    <strong>Active Clients: ${clients.filter(c => c.status === 'Active').length}</strong><br>
                    <pre>${JSON.stringify(clients.slice(0, 3), null, 2)}</pre>
                    <button onclick="showAllClients()">Show All Clients</button>
                `;
                
                // Store clients globally for other functions
                window.debugClients = clients;
                
                // Fetch payments
                const paymentsResponse = await fetch(`${API_BASE}/api/payments/stats`);
                const payments = await paymentsResponse.json();
                
                document.getElementById('paymentsContent').innerHTML = `
                    <div class="success">
                        <strong>Total Revenue: TTD ${payments.total_revenue}</strong><br>
                        <strong>Monthly Revenue: TTD ${payments.monthly_revenue}</strong><br>
                        <strong>Payment Count: ${payments.payment_count}</strong><br>
                    </div>
                    <pre>${JSON.stringify(payments, null, 2)}</pre>
                `;
                
                // Find test clients
                const testClients = clients.filter(client => 
                    client.name.toLowerCase().includes('test') || 
                    client.email.includes('test') || 
                    client.email.includes('example.com') ||
                    client.name.toLowerCase().includes('tata') ||
                    client.name.toLowerCase().includes('john')
                );
                
                document.getElementById('testClientsContent').innerHTML = `
                    <strong>Found ${testClients.length} test clients:</strong><br>
                    ${testClients.map(client => `
                        <div class="client-card test-client">
                            <strong>${client.name}</strong><br>
                            Email: ${client.email}<br>
                            Status: ${client.status}<br>
                            Monthly Fee: TTD ${client.monthly_fee}<br>
                            Next Payment: ${client.next_payment_date}
                        </div>
                    `).join('')}
                `;
                
                log('‚úÖ All data fetched successfully');
                
            } catch (error) {
                log('‚ùå Data fetch failed: ' + error.message);
            }
        }
        
        function showAllClients() {
            if (window.debugClients) {
                const clientsList = window.debugClients.map(client => `
                    <div class="client-card ${client.name.toLowerCase().includes('test') || client.email.includes('test') ? 'test-client' : ''}">
                        <strong>${client.name}</strong> (${client.status})<br>
                        ${client.email} - TTD ${client.monthly_fee}<br>
                        Next Payment: ${client.next_payment_date}
                    </div>
                `).join('');
                
                document.getElementById('clientsContent').innerHTML = `
                    <strong>All ${window.debugClients.length} Clients:</strong><br>
                    ${clientsList}
                `;
            }
        }
        
        // Auto-run connection test on page load
        window.onload = function() {
            testAPIConnection();
        };
    </script>
</body>
</html>